<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion de chantier — Démo Artisan</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800">

<div id="app">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Gestion de chantier — Démo Artisan</h1>
    <button id="generate-text" class="bg-green-500 p-2 rounded">Générer texte Landing Page</button>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <nav id="sidebar" class="w-64 p-4 bg-gray-100 h-screen">
      <ul class="space-y-2">
        <li><button class="w-full text-left" onclick="setActiveView('dashboard')">Tableau de bord</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('projects')">Chantiers</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('quotes')">Devis & Factures</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('planning')">Planning</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('employees')">Salariés</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('materials')">Matériaux</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('ae')">Auto-entrepreneur</button></li>
        <li><button class="w-full text-left" onclick="setActiveView('settings')">Paramètres</button></li>
      </ul>
    </nav>

    <!-- Main content -->
    <main id="main-content" class="flex-1 p-4"></main>
  </div>

  <!-- Affichage du texte Gemini -->
  <div id="gemini-output" class="p-4 border-t"></div>
</div>

<script>
  // ==========================
  // 1️⃣ Clé API globale
  // ==========================
  window.GEMINI_API_KEY = AIzaSyAV-oQQ9hnAywalaWPznyBpiOKUVprn9tA; // <-- remplace par ta clé Gemini

  // Fonction globale pour Gemini
  window.callGemini = async function(prompt) {
      if(!window.GEMINI_API_KEY) return alert("Clé API manquante !");
      const response = await fetch("https://api.gemini.com/v1/responses", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${window.GEMINI_API_KEY}`
          },
          body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      return data;
  };

  // Bouton test Gemini
  document.getElementById("generate-text").addEventListener("click", async ()=>{
      const output = await window.callGemini("Génère un texte pour ma landing page");
      document.getElementById("gemini-output").innerText = output.output_text || JSON.stringify(output);
  });

  // ==========================
  // 2️⃣ Initialisation des données
  // ==========================
  let state = JSON.parse(localStorage.getItem('appState')) || initState();

  function initState(){
      const year = new Date().getFullYear();
      const demoState = {
          projects:[
              {id:1,name:"Maison Dupont",client:"Dupont",start:`${year}-06-01`,end:`${year}-08-01`,status:"En cours",tasks:["Préparer terrain"],materials:[1],employees:[1],quotes:[1],invoices:[1]},
              {id:2,name:"Appartement Martin",client:"Martin",start:`${year}-05-01`,end:`${year}-06-15`,status:"Terminé",tasks:["Peinture"],materials:[2],employees:[2],quotes:[2],invoices:[2]},
              {id:3,name:"Bureau Leroy",client:"Leroy",start:`${year}-09-01`,end:`${year}-10-15`,status:"Prévu",tasks:[],materials:[],employees:[1],quotes:[],invoices:[]}
          ],
          clients:["Dupont","Martin","Leroy"],
          employees:[
              {id:1,name:"Jean",role:"Chef de chantier"},
              {id:2,name:"Lucie",role:"Ouvrier"},
              {id:3,name:"Ahmed",role:"Électricien"}
          ],
          quotes:[
              {id:1,number:"DEV-2025-001",client:"Dupont",project:1,lines:[{desc:"Peinture",qty:2,unit:50}],status:"Accepté"},
              {id:2,number:"DEV-2025-002",client:"Martin",project:2,lines:[{desc:"Carrelage",qty:3,unit:40}],status:"Brouillon"}
          ],
          invoices:[
              {id:1,number:"FAC-2025-001",client:"Dupont",project:1,lines:[{desc:"Peinture",qty:2,unit:50}],status:"Payée",due:`${year}-08-10`},
              {id:2,number:"FAC-2025-002",client:"Martin",project:2,lines:[{desc:"Carrelage",qty:3,unit:40}],status:"Brouillon",due:`${year}-06-20`}
          ],
          materials:[
              {id:1,name:"Plaque BA13"},{id:2,name:"Carrelage 60x60"}
          ],
          settings:{status:"Auto-entrepreneur",plafond:77700}
      };
      localStorage.setItem('appState',JSON.stringify(demoState));
      return demoState;
  }

  // ==========================
  // 3️⃣ Navigation
  // ==========================
  function setActiveView(view){
      const main=document.getElementById('main-content');
      main.innerHTML="";
      if(view==='dashboard') renderDashboard();
      if(view==='projects') renderProjectsView();
      if(view==='quotes') renderQuotesView();
      if(view==='planning') renderPlanningView();
      if(view==='employees') renderEmployeesView();
      if(view==='materials') renderMaterialsView();
      if(view==='ae') renderAEView();
      if(view==='settings') renderSettingsView();
  }

  // ==========================
  // 4️⃣ Dashboard dynamique
  // ==========================
  function renderDashboard(){
      const main=document.getElementById('main-content');
      const total=state.projects.length;
      const inProgress=state.projects.filter(p=>p.status==="En cours").length;
      const finished=state.projects.filter(p=>p.status==="Terminé").length;
      const delayed=state.projects.filter(p=>p.status==="En retard").length;
      const totalQuotes=state.quotes.length;
      const acceptedQuotes=state.quotes.filter(q=>q.status==="Accepté").length;
      const caTotal=state.invoices.reduce((sum,f)=>sum+f.lines.reduce((s,l)=>s+l.qty*l.unit,0),0);

      main.innerHTML=`
          <h2 class="text-lg font-bold mb-4">Tableau de bord</h2>
          <p>Total chantiers: ${total}</p>
          <p>En cours: ${inProgress}</p>
          <p>Terminés: ${finished}</p>
          <p>En retard: ${delayed}</p>
          <p>Total devis: ${totalQuotes}, acceptés: ${acceptedQuotes}</p>
          <p>CA total factures: ${caTotal} €</p>
      `;
  }

  // ==========================
  // 5️⃣ Vue Chantiers
  // ==========================
  function renderProjectsView(){
      const main=document.getElementById('main-content');
      main.innerHTML="<h2 class='text-lg font-bold mb-4'>Chantiers</h2>";

      state.projects.forEach(p=>{
          const div=document.createElement('div');
          div.className="border p-2 mb-2";
          const assignedEmployees=p.employees.map(id=>state.employees.find(e=>e.id===id)?.name).join(", ");
          const tasks=p.tasks.map((t,i)=>`<li><input type='checkbox'> ${t}</li>`).join("");
          div.innerHTML=`
              <strong>${p.name}</strong> — ${p.status} — Client: ${p.client}<br>
              <em>Responsables: ${assignedEmployees}</em>
              <ul>${tasks}</ul>
          `;
          main.appendChild(div);
      });

      // Formulaire création chantier
      const form=document.createElement('div');
      form.className="mt-4 p-2 border";
      form.innerHTML=`
          <h3 class="font-bold">Ajouter nouveau chantier</h3>
          <input type="text" id="newProjectName" placeholder="Nom chantier" class="border p-1 mr-2">
          <input type="text" id="newProjectClient" placeholder="Client" class="border p-1 mr-2">
          <button class="bg-blue-500 text-white p-1 rounded" id="addProjectBtn">Ajouter</button>
      `;
      main.appendChild(form);
      document.getElementById("addProjectBtn").addEventListener("click",()=>{
          const name=document.getElementById("newProjectName").value;
          const client=document.getElementById("newProjectClient").value;
          if(name && client){
              const newProject={id:Date.now(),name,client,start:"2025-01-01",end:"2025-12-31",status:"Prévu",tasks:[],materials:[],employees:[],quotes:[],invoices:[]};
              state.projects.push(newProject);
              saveState();
              setActiveView('projects');
          }
      });
  }

  // ==========================
  // 6️⃣ Vues simplifiées
  // ==========================
  function renderQuotesView(){const main=document.getElementById('main-content');main.innerHTML="<h2>Devis & Factures</h2>";state.quotes.forEach(q=>{main.innerHTML+=`<p>${q.number} — ${q.client} — ${q.status}</p>`});state.invoices.forEach(f=>{main.innerHTML+=`<p>${f.number} — ${f.client} — ${f.status}</p>`})}
  function renderPlanningView(){const main=document.getElementById('main-content');main.innerHTML="<h2>Planning Hebdomadaire</h2>";state.projects.forEach(p=>{main.innerHTML+=`<p>${p.name} : ${p.start} → ${p.end}</p>`})}
  function renderEmployeesView(){const main=document.getElementById('main-content');main.innerHTML="<h2>Salariés</h2>";state.employees.forEach(e=>{main.innerHTML+=`<p>${e.name} — ${e.role}</p>`})}
  function renderMaterialsView(){const main=document.getElementById('main-content');main.innerHTML="<h2>Matériaux</h2>";state.materials.forEach(m=>{main.innerHTML+=`<p>${m.name}</p>`})}
  function renderAEView(){const main=document.getElementById('main-content');const ca=state.invoices.filter(f=>["Payée","Envoyée"].includes(f.status)).reduce((sum,f)=>sum+f.lines.reduce((s,l)=>s+l.qty*l.unit,0),0);main.innerHTML=`<h2>Auto-entrepreneur</h2><p>CA annuel : ${ca} €</p>`;}
  function renderSettingsView(){const main=document.getElementById('main-content');main.innerHTML="<h2>Paramètres</h2><button onclick='resetData()' class='bg-red-500 text-white p-2 rounded'>Réinitialiser données</button>";}

  function resetData(){localStorage.removeItem('appState');state=initState();setActiveView('dashboard');}
  function saveState(){localStorage.setItem('appState',JSON.stringify(state));}

  // Vue par défaut
  setActiveView('dashboard');
</script>

</body>
</html>
