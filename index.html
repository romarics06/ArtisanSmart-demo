<script>
  // Attendre que le DOM soit prêt (fix principal)
  document.addEventListener('DOMContentLoaded', function() {
    // ==========================
    // 1️⃣ Clé API Gemini (ta clé est bonne)
    // ==========================
    window.GEMINI_API_KEY = "AIzaSyAV-oQQ9hnAywalaWPznyBpiOKUVprn9tA";

    // Fonction Gemini (endpoint correct 1.5 Flash)
    window.callGemini = async function(prompt, isTest = false) {
      if (!window.GEMINI_API_KEY || window.GEMINI_API_KEY.includes("remplace")) {
        alert("Clé API manquante ! Active-la dans Google AI Studio.");
        return null;
      }

      const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${window.GEMINI_API_KEY}`;

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
          })
        });

        if (!response.ok) {
          const err = await response.text();
          throw new Error(`Erreur ${response.status}: ${err}`);
        }

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        return isTest ? "✅ API Gemini 1.5 Flash OK – tout fonctionne !" : text;

      } catch (error) {
        console.error("Erreur Gemini:", error);
        alert(`Erreur: ${error.message}\nVérifie ta clé sur aistudio.google.com/app/apikey`);
        return null;
      }
    };

    // Boutons (après DOM ready)
    document.getElementById("test-api").addEventListener("click", async () => {
      const result = await window.callGemini("Dis bonjour en français.", true);
      const outputDiv = document.getElementById("gemini-output");
      outputDiv.classList.remove("hidden");
      document.getElementById("output-content").innerHTML = `<p class="text-green-600 font-bold">${result}</p>`;
    });

    document.getElementById("generate-text").addEventListener("click", async () => {
      const prompt = `Génère un texte LP pour ArtisanSmart SaaS artisans bâtiment. Hero + features KPI + pricing + CTA. Ton simple pro.`;
      const output = await window.callGemini(prompt);
      if (output) {
        document.getElementById("gemini-output").classList.remove("hidden");
        document.getElementById("output-content").innerHTML = `<pre class="bg-white p-4 rounded overflow-auto text-sm">${output}</pre>`;
      }
    });

    // ==========================
    // 2️⃣ Initialisation state (avec gestion erreur)
    // ==========================
    let state;
    try {
      state = JSON.parse(localStorage.getItem('appState')) || initState();
    } catch (e) {
      console.warn("State corrompu, reset:", e);
      state = initState();
    }

    function initState() {
      const year = new Date().getFullYear();
      const demoState = {
        // ... (ton state existant, inchangé)
        projects: [...], // Colle ton state complet ici si besoin
        // etc.
      };
      localStorage.setItem('appState', JSON.stringify(demoState));
      return demoState;
    }

    // ==========================
    // 3️⃣ Navigation (inchangée, mais appelée après DOM)
    // ==========================
    function setActiveView(view) {
      // Ton code navigation existant...
      const main = document.getElementById('main-content');
      main.innerHTML = '';
      if (view === 'dashboard') renderDashboard();
      // ... (reste inchangé)
    }

    // Vue par défaut après tout
    setActiveView('dashboard');
  });
</script>
